<?php function base64url_encode($data){return rtrim(strtr(base64_encode($data),"+/","-_"),"=");}function getSignedJWTToken($email,$privateKey,$aud,$scope,$uid,$claims){$base64UrlHeader=base64url_encode(json_encode(["alg"=>"RS256","typ"=>"JWT",]));$now=time();$payload=["iss"=>$email,"sub"=>$email,"aud"=>$aud,"iat"=>$now,"exp"=>$now+3600,];if($scope!=""){$payload["scope"]=$scope;}if($uid!=""){$payload["uid"]=$uid;}if($claims!=""){$payload["claims"]=$claims;}$payloadStr=json_encode($payload);$base64UrlPayload=base64url_encode(str_replace("\\","",$payloadStr));openssl_sign($base64UrlHeader.".".$base64UrlPayload,$RSA256,$privateKey,"sha256WithRSAEncryption");$keyRSA256=base64url_encode($RSA256);$jwt=$base64UrlHeader.".".$base64UrlPayload.".".$keyRSA256;return $jwt;}function getAuthToken($email,$privateKey,$aud,$scope,$uid,$claims){if($email==""||$privateKey==""){return "";}$ch=curl_init();$post=["grant_type"=>"urn:ietf:params:oauth:grant-type:jwt-bearer","assertion"=>getSignedJWTToken($email,$privateKey,$aud,$scope,$uid,$claims),];curl_setopt($ch,CURLOPT_URL,"https://oauth2.googleapis.com/token");curl_setopt($ch,CURLOPT_POST,true);curl_setopt($ch,CURLOPT_POSTFIELDS,$post);curl_setopt($ch,CURLOPT_RETURNTRANSFER,true);$server_output=curl_exec($ch);$json=json_decode($server_output,true);curl_close($ch);if(isset($json["access_token"])){$data=["status"=>"success","msg"=>"Successfully get access token","token"=>$json["access_token"],];}else{$data=["status"=>"failure","msg"=>$json["error_description"],"token"=>"",];}return $data;}$jsonData=file_get_contents("php://input");$data=json_decode($jsonData,true);if($data!==null){$email=$data["email"];$privateKey=$data["privateKey"];$privateKey=str_replace("\\n","\n",$privateKey);$aud=$data["aud"];$scope=$data["scope"];$uid=$data["uid"];$claims=$data["claims"];if(!filter_var($email,FILTER_VALIDATE_EMAIL)){$data=["status"=>"failure","msg"=>"Invalid Client Email","token"=>"",];}else{if(openssl_pkey_get_private($privateKey)){$return=getAuthToken($email,$privateKey,$aud,$scope,$uid,$claims);if($return["status"]=="success"){$data=["status"=>"success","msg"=>"Successfully get access token","token"=>$return["token"],];}else{$data=["status"=>"failure","msg"=>$return["msg"],"token"=>"",];}}else{$data=["status"=>"failure","msg"=>"Invalid Private Key","token"=>"",];}}header("Content-type: application/json");echo json_encode($data);}else{$file=basename($_SERVER["SCRIPT_FILENAME"],".php");if(file_exists($file.".html")){$str=file_get_contents($file.".html");echo $str;}else{echo "Unable to locate ".$file.".html. <br/>Please put ".$file.".html in the same directory of this ".$file.".php.";}} ?>